# 烤箱數據監控系統 (Oven Data Receive)

一個基於 Blazor Server 的 Modbus TCP 數據監控系統，用於即時監控烤箱設備的開關量狀態和溫度數據。

## 📋 目錄

- [功能特點](#功能特點)
- [系統需求](#系統需求)
- [硬體連接](#硬體連接)
- [安裝與配置](#安裝與配置)
- [運行應用](#運行應用)
- [使用說明](#使用說明)
- [配置參數](#配置參數)
- [注意事項](#注意事項)
- [技術架構](#技術架構)

## ✨ 功能特點

- ✅ **即時數據監控** - 支援 Modbus TCP 協議，即時讀取設備數據
- ✅ **開關量輸入 (DI)** - 監控 32 路離散輸入狀態
- ✅ **溫度監控** - 支援 12 個 ADTEK CM1 溫度表讀取
- ✅ **自動重連** - 連接斷開時自動重試連接
- ✅ **即時更新** - 可配置的數據讀取間隔（預設 2000ms）

## 💻 系統需求

- .NET 9.0 SDK 或更高版本
- Windows 10/11 或 Linux 作業系統
- 支援 Modbus TCP 的設備（如 SHZK-DI 開關量采集設備）
- 網路連接（設備與電腦需在同一網路）

## 🔌 硬體連接

### 1. 網路連接

將 Modbus 設備的網口連接到與電腦相同的區域網路：

```
設備網口 ──→ 交換機/路由器 ──→ 電腦網卡
```

### 2. 電源供應

- **工作電壓**：DC 6-35V
- **工作電流**：≥50mA
- **功耗**：12V 工作電壓下，最大 1W

### 3. 設備配置

確保設備已正確配置：
- **IP 地址**：預設為 `192.168.61.144`（可透過設備管理軟體修改）
- **Modbus TCP 端口**：預設為 `4196`
- **設備地址 (Unit ID)**：預設為 `1`

## 📦 安裝與配置

### 1. 克隆專案

```bash
git clone <repository-url>
cd OvenDataReceive/Oven/OvenDataReceive
```

### 2. 還原 NuGet 套件

```bash
dotnet restore
```

### 3. 配置應用程式

編輯 `appsettings.json` 檔案：

```json
{
  "Modbus": {
    "IpAddress": "192.168.61.144",     // Modbus TCP 閘道器 IP 地址
    "Port": 4196,                       // Modbus TCP 端口
    "DiUnitId": 255,                    // DI 採集器 Unit ID
    "TempSensorCount": 12,              // 溫度感測器數量（Unit ID 1-12）
    "TempRegisterAddr": 0,              // 溫度寄存器地址（ADTEK CM1 PV = 0x0000）
    "ReadIntervalMs": 2000,             // 讀取間隔（毫秒，範圍：500-10000）
    "SensorTimeoutMs": 1000             // 單一感測器超時（毫秒，範圍：200-5000）
  }
}
```

### 4. 配置參數說明

| 參數 | 說明 | 預設值 | 範圍 |
|------|------|--------|------|
| `IpAddress` | Modbus TCP 閘道器的 IP 地址 | `192.168.61.144` | - |
| `Port` | Modbus TCP 端口 | `4196` | 1-65535 |
| `DiUnitId` | DI 採集器 Unit ID | `255` | 1-255 |
| `TempSensorCount` | 溫度感測器數量（每個感測器的 Unit ID = 序號） | `12` | 1-32 |
| `TempRegisterAddr` | 溫度寄存器地址（ADTEK CM1 PV = 0） | `0` | 0-65535 |
| `ReadIntervalMs` | 數據讀取間隔（毫秒） | `2000` | 500-10000 |
| `SensorTimeoutMs` | 單一感測器超時（毫秒） | `1000` | 200-5000 |

## 🚀 運行應用

### 開發模式

```bash
dotnet run
```

應用程式將在以下地址啟動：
- HTTP: `http://localhost:5000`
- HTTPS: `https://localhost:5001`

### 生產模式

```bash
dotnet build -c Release
dotnet run -c Release
```

### 發布應用

```bash
dotnet publish -c Release -o ./publish
```

## 📖 使用說明

### 1. 訪問應用

開啟瀏覽器，訪問 `http://localhost:5000` 或 `https://localhost:5001`

### 2. 監控頁面

導航至「監控」頁面 (`/monitor`)，您將看到：

#### **站點監控**
- 顯示 12 個溫度感測站的即時狀態（ADTEK CM1 溫度表）
- DI 狀態控制：DI = ON 時讀取溫度，DI = OFF 時設備停止
- 按設備類別分組顯示：
  - 🔥 **加硫與處理劑設備**：加硫機、藥水箱
  - 💧 **膠水活化/乾燥烘箱**：一次膠、二次膠
  - ❄️ **冷卻與定型設備**：冷凍機、冷熱定型機

#### **溫度顯示**
- 根據溫度範圍顯示不同顏色：
  - 🔵 正常：< 100°C
  - 🟡 溫熱：100-150°C
  - 🟠 中等：150-200°C
  - 🔴 高溫：≥ 200°C
  - 🩵 低溫：< 0°C（冷凍設備）

#### **其他開關量 (DI13-DI32)**
- 顯示額外的離散輸入狀態

### 3. 連接狀態

頁面頂部顯示設備連接狀態：
- 🟢 **已連線** - 設備正常連接
- 🔴 **未連線** - 無法連接到設備

## ⚙️ 配置參數

### 溫度感測器（ADTEK CM1 系列）

本系統使用 **ADTEK CM1 系列數位溫度表**，透過 RS485 轉 Modbus TCP 閘道器進行通訊。

**Modbus 通訊規格：**
- 寄存器地址：`0x0000`（PV 顯示值）
- 功能碼：03 (Read Holding Registers) 或 04 (Read Input Registers)
- 數據類型：16 位元有符號整數（`short`）

**溫度換算公式：**
```
實際溫度 = RawValue / 10.0
```

**範例：**
| 原始值 (Raw) | 實際溫度 |
|-------------|---------|
| 1525 | 152.5°C |
| 250 | 25.0°C |
| -100 | -10.0°C |

**有效範圍：**
- 原始值：-1999 ~ 9999
- 對應溫度：-199.9°C ~ 999.9°C

**錯誤處理：**
- 若原始值 < -1999（如 65535 → -1），代表感測器異常，溫度顯示為 0

## ⚠️ 注意事項

### 1. 硬體架構說明

本系統使用以下設備：
- **SHZK-DI 開關量采集器**：負責讀取 32 路 DI 狀態
- **ADTEK CM1 數位溫度表**：12 台，透過 RS485 連接
- **Modbus TCP 閘道器**：將 RS485 轉換為 Modbus TCP

### 2. 網路連接

- 確保設備與電腦在同一區域網路
- 檢查防火牆設定，確保端口 `4196` 未被阻擋
- 使用 `ping` 命令測試設備連通性：
  ```bash
  ping 192.168.61.144
  ```

### 3. 讀取間隔設定

- **建議值**：2000ms（2 秒）
- **最小值**：500ms（過低可能導致設備響應不及）
- **最大值**：10000ms（過高會影響數據即時性）

### 4. 錯誤處理

- 連接失敗時，系統會自動重試（間隔 1 秒）
- 讀取失敗時，會保留上次成功讀取的數據
- 查看應用程式日誌以獲取詳細錯誤資訊

## 🏗️ 技術架構

### 技術棧

- **框架**：ASP.NET Core 9.0
- **UI**：Blazor Server
- **Modbus 通訊**：FluentModbus 5.0.0
- **後端服務**：Background Service

### 專案結構

```
OvenDataReceive/
├── Components/
│   ├── Pages/
│   │   ├── Monitor.razor      # 監控頁面
│   │   └── Home.razor         # 首頁
│   └── Layout/
│       └── MainLayout.razor   # 主佈局
├── Services/
│   └── ModbusDataService.cs   # Modbus 數據服務
├── Program.cs                  # 應用程式入口
├── appsettings.json           # 配置文件
└── OvenDataReceive.csproj     # 專案文件
```

### 核心服務

**ModbusDataService** (`Services/ModbusDataService.cs`)
- 負責 Modbus TCP 連接管理
- 定期讀取設備數據
- 提供線程安全的數據訪問接口
- 支援自動重連機制

## 🔍 除錯與故障排除

### 問題：無法連接到設備

**解決方案：**
1. 檢查設備 IP 地址是否正確
2. 確認設備已開機並連接到網路
3. 檢查端口號是否正確（預設 4196）
4. 使用 Modbus 測試工具（如 Modbus Poll）驗證設備連接

### 問題：溫度數據顯示為 0

**解決方案：**
1. 確認對應的 DI 狀態是否為 ON（DI = OFF 時不會讀取溫度）
2. 檢查 ADTEK CM1 溫度表是否正常運作
3. 檢查 RS485 通訊線路是否正常
4. 查看日誌檔案 `Logs/RawData.txt` 確認原始數據
5. 若原始值顯示為負數且 < -1999，代表感測器異常

### 問題：數據更新延遲

**解決方案：**
1. 降低 `ReadIntervalMs` 值（建議不低於 100ms）
2. 檢查網路延遲
3. 確認設備響應速度

## 📞 技術支援

如有問題或建議，請聯繫開發團隊。

## 📄 授權

本專案為內部使用專案。

---

**最後更新**：2026年1月

